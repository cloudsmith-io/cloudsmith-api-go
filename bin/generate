#!/usr/bin/env bash
set -eou pipefail


PKG_VERSION=${1:-"0.0.14"}
API_HOST=${2:-"https://api.cloudsmith.io"}


function api_version {
    curl -s "$API_HOST/status/check/basic/" | jq -r '.version'
}

function swagger_spec {
    temp_file=$(mktemp)
    curl -Ls "$API_HOST/?format=openapi" | jq ".info.version = \"$1\"" > "$temp_file"
    echo "$temp_file"
}

# Generate client library
API_VERSION="$(api_version)"
SWAGGER_SPEC="$(swagger_spec "$API_VERSION")"
DOCKER_IMAGE="$(docker build -q .)"

docker run --rm \
    -e PKG_VERSION="$PKG_VERSION" \
    -e GO_POST_PROCESS_FILE="gofmt -w" \
    -v "$SWAGGER_SPEC":/tmp/swagger_spec \
    -v "$PWD":/local "$DOCKER_IMAGE" generate \
    --input-spec /tmp/swagger_spec \
    --generator-name go \
    --git-user-id cloudsmith-io \
    --git-repo-id cloudsmith-api-go \
    --additional-properties packageName=cloudsmith \
    --additional-properties packageVersion="$PKG_VERSION" \
    --type-mappings integer=int64,number=float64,float=float64 \
    --enable-post-process-file


# Clean up unused files post-generation

rm -v .travis.yml
rm -v git_push.sh
